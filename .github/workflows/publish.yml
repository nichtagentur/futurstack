name: Publish Pipeline (2-3 articles/week)

on:
  schedule:
    # Tuesday 8 AM, Thursday 8 AM, Saturday 10 AM UTC
    - cron: '0 8 * * 2'   # Tuesday
    - cron: '0 8 * * 4'   # Thursday
    - cron: '0 10 * * 6'  # Saturday
  workflow_dispatch:
    inputs:
      mode:
        description: 'Pipeline mode'
        default: 'auto'
        type: choice
        options:
          - auto            # Smart calendar picks next article
          - manual-review   # Specify tool below
          - manual-comparison
          - manual-guide
          - dry-run         # Generate but don't deploy
      tool_id:
        description: 'Tool ID (for manual-review mode)'
        default: ''
        type: string
      topic:
        description: 'Topic or tool pair (for guide/comparison)'
        default: ''
        type: string

permissions:
  contents: write

jobs:
  publish:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v3
        with:
          hugo-version: '0.123.7'
          extended: true

      - name: Run Publishing Pipeline
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          CLAUDE_API_KEY_1: ${{ secrets.ANTHROPIC_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
        run: |
          MODE="${{ github.event.inputs.mode || 'auto' }}"
          TOOL="${{ github.event.inputs.tool_id }}"
          TOPIC="${{ github.event.inputs.topic }}"

          ARGS=""
          case "$MODE" in
            auto)
              ARGS=""
              ;;
            manual-review)
              ARGS="--force-type review --force-tool $TOOL"
              ;;
            manual-comparison)
              ARGS="--force-type comparison --force-tools $TOPIC"
              ;;
            manual-guide)
              ARGS="--force-type guide --force-topic \"$TOPIC\""
              ;;
            dry-run)
              ARGS="--dry-run"
              ;;
          esac

          node scripts/publish-pipeline.js $ARGS

      - name: Deploy to Vercel
        if: ${{ github.event.inputs.mode != 'dry-run' }}
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
        run: |
          npm i -g vercel@latest
          vercel --prod --token "$VERCEL_TOKEN" --yes
        continue-on-error: true

      - name: Commit generated content
        if: ${{ github.event.inputs.mode != 'dry-run' }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add content/ static/images/ data/ qa-report.json
          git diff --cached --quiet || git commit -m "Publish: auto-generated content $(date +%Y-%m-%d)"
          git push

      - name: Ping Google Sitemap
        if: ${{ github.event.inputs.mode != 'dry-run' }}
        run: node scripts/submit-sitemap.js
        continue-on-error: true
